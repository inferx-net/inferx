<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title> InferX AI Function </title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        nav a {
            color: #d64161;
            font-size: 3em;
            margin-left: 50px;
            text-decoration: none;
        }

        .content table.ix-table {
            border-collapse: collapse;
            background: #fff;
        }

        .content table.ix-table th,
        .content table.ix-table td {
            border: 1px solid #aebfd1;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }

        .content table.ix-table th {
            background: #f8fafc;
            color: #334155;
            font-weight: 600;
        }

        .content table.ix-table tbody tr:nth-child(odd) {
            background: #ffffff;
        }

        .content table.ix-table tbody tr:nth-child(even) {
            background: #edf3fb;
        }

        .content table.ix-table tbody tr:hover {
            background: #e2ecf9;
        }

        .content table.ix-table.ix-table-compact th,
        .content table.ix-table.ix-table-compact td {
            padding: 4px 6px;
        }

        .audit {
            padding: 20px;
            margin: 10px;
            background-color: #f7f4f4;
        }

        .review {
            margin-left: 50px;
            font-size: 20px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

    </style>
</head>

<body>
    <table style="border-collapse: collapse; border: 2px solid rgba(255, 255, 255, 0.5);">
        <td style="border: none;"><img src="doc/logo.png" alt="logo" width="100" height="100"></td>
        <td style="border: none;">
            <h1>InferX AI Function Platform (Lambda Function for Inference)</h1>
            <h2>&nbsp;&nbsp;&nbsp;&nbsp;-- &nbsp; Serve tens models in one box with ultra-fast (<2 sec) cold start
                    (contact: support@inferx.net)</</h2>
        </td>
    </table>
    <div class="topbar">
        <a href="#" id="login_logout" style="font-size: 2em; margin-left: auto;">Action</a>
    </div>
    <hr>
    <nav>
        <a href="{{ hosturl }}intro"> Introduction </a>
        <a href="{{ hosturl }}listfunc"> Models </a>
        <a href="{{ hosturl }}listpod"> Pods </a>
        <a href="{{ hosturl }}listsnapshot"> Snapshots </a>
        <a href="{{ hosturl }}listnode"> Nodes </a>
        <a href="{{ hosturl }}admin" id="admin"> Admin </a>
    </nav>
    <script>
        const link = document.querySelector('#login_logout');
        const username = {{ session.get('username', '') | tojson }};
        const userDisplayName = {{ session.get('display_name', session.get('username', '')) | tojson }};
        const activeTenantName = {{ session.get('active_tenant_name', session.get('tenant_name', '')) | tojson }};
        const tenantDisplayMap = {};

        function tenantDisplayNameFromTenantObject(tenantObj) {
            if (!tenantObj) {
                return "";
            }

            const spec = tenantObj.object && tenantObj.object.spec ? tenantObj.object.spec : {};
            const displayName = (spec.display_name || spec.displayName || "").trim();
            if (displayName !== "") {
                return displayName;
            }

            return (tenantObj.name || "").trim();
        }

        function getTenantDisplayName(tenantName) {
            if (!tenantName) {
                return "";
            }

            const mapped = tenantDisplayMap[tenantName];
            if (typeof mapped === 'string' && mapped.trim() !== "") {
                return mapped;
            }

            return tenantName;
        }

        function applyTenantDisplayNames(root = document) {
            if (!root || !root.querySelectorAll) {
                return;
            }

            const elems = root.querySelectorAll('[data-tenant-name]');
            elems.forEach((elem) => {
                const tenantName = (elem.dataset.tenantName || '').trim();
                if (tenantName === "") {
                    return;
                }

                const displayName = getTenantDisplayName(tenantName);
                elem.textContent = displayName;
                elem.title = tenantName;
            });
        }

        function refreshTenantBadge() {
            return;
        }

        function updateTenantDisplayMap(entries) {
            if (!entries || typeof entries !== 'object') {
                return;
            }

            Object.entries(entries).forEach(([tenantName, displayName]) => {
                const tn = String(tenantName || '').trim();
                if (tn === '') {
                    return;
                }

                const dn = String(displayName || '').trim();
                tenantDisplayMap[tn] = dn === '' ? tn : dn;
            });

            applyTenantDisplayNames(document);
            refreshTenantBadge();
            document.dispatchEvent(new CustomEvent('tenant-display-map-updated'));
        }

        async function loadTenantDisplayMap() {
            if (username === '') {
                refreshTenantBadge();
                return;
            }

            try {
                const resp = await fetch('/demo/generate_tenants');
                if (!resp.ok) {
                    refreshTenantBadge();
                    return;
                }

                const tenants = await resp.json();
                const updates = {};
                tenants.forEach((tenantObj) => {
                    const tenantName = String(tenantObj.name || '').trim();
                    if (tenantName === '') {
                        return;
                    }

                    const displayName = tenantDisplayNameFromTenantObject(tenantObj);
                    updates[tenantName] = displayName === '' ? tenantName : displayName;
                });

                updateTenantDisplayMap(updates);
            } catch (_e) {
                refreshTenantBadge();
            }
        }

        window.getTenantDisplayName = getTenantDisplayName;
        window.applyTenantDisplayNames = applyTenantDisplayNames;
        window.updateTenantDisplayMap = updateTenantDisplayMap;
        window.tenantDisplayNameFromTenantObject = tenantDisplayNameFromTenantObject;

        if (username == "") {
            link.href = '{{ hosturl }}' + "login";
            link.textContent = 'login'
        } else {
            link.href = '{{ hosturl }}' + "logout";
            link.textContent = "logout(" + userDisplayName + ")";
        }

        refreshTenantBadge();
        applyTenantDisplayNames(document);
        loadTenantDisplayMap();

    </script>
    <hr>
    <div class="content">
        {% block content %} {% endblock %}
    </div>
</body>

</html>
